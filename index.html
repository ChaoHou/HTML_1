<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>App</title>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
	<style>
	text{
		pointer-events:none;
		cursor:pointer;
	}
 
	.line {
		fill: none;
		//stroke: steelblue;
		stroke-width: 1.5px;
	}
	.arc path {
		stroke: white;
		stroke-width: 2px;
	}
	.bar {
		fill: steelblue;
	}
	.axis{
		fill: none;
		stroke: #000;
		shape-rendering: crispEdges;
	}
	
	#pool:hover{
		fill: GoldenRod ;
	}
	#closeButton:hover{
		fill: GoldenRod ;
	}
	</style>
  </head>
  <body>
  <script>
    
    var teams =  [{"text":"Adelaide Thunderbirds","title":"AT"},
                  {"text":"Canterbury Tactix","title":"CT"},
                  {"text":"Central Pulse","title":"CP"},
                  {"text":"Melbourne Vixens","title":"MV"},
                  {"text":"New South Wales Swifts","title":"NS"},
                  {"text":"Northern Mystics","title":"NM"},
                  {"text":"Queensland Firebirds","title":"QF"},
                  {"text":"Southern Steel","title":"SS"},
                  {"text":"Waikato Bay of Plenty Magic","title":"WB"},
                  {"text":"West Coast Fever","title":"WCF"}];
    initArray(teams,"red","team");
       
    var countries = [{"text":"New Zealand","title":"NZ"},
                    {"text":"Australian","title":"AU"}];
    initArray(countries,"blue","country");
  
    var venues = [{"text":"Adelaide Arena, Adelaide","title":"AAA"},
                  {"text":"Arena Manawatu, Palmerston North","title":"AM"},
                  {"text":"Brisbane Convention and Exhibition Centre","title":"BC"},
                  {"text":"Challenge Stadium, Perth","title":"CS"},
                  {"text":"ETSA Park, Adelaide","title":"EP"},
                  {"text":"Energy Events Centre, Rotorua","title":"EEC"},
                  {"text":"Hisense Arena, Melbourne","title":"HA"},
                  {"text":"Mystery Creek Events Centre, Hamilton","title":"MC"},
                  {"text":"North Shore Events Centre, Auckland","title":"NSE"},
                  {"text":"Queen Elizabeth Youth Centre, Tauranga","title":"QE"},
                  {"text":"Stadium Southland, Invercargill","title":"SSI"},
                  {"text":"State Netball and Hockey Centre, Melbourne","title":"SN"},
                  {"text":"Sydney Olympic Park Sports Centre","title":"SO"},
                  {"text":"TSB Bank Arena, Wellington","title":"TB"},
                  {"text":"Te Rauparaha Arena, Porirua","title":"TR"},
                  {"text":"The Edgar Centre, Dunedin","title":"TE"},
                  {"text":"Trusts Stadium, Auckland","title":"TS"},
                  {"text":"Westpac Arena, Christchurch","title":"WA"}];
    initArray(venues,"green","venue");
    
	var years = [{"title":2008},
				 {"title":2009},
				 {"title":2010},
				 {"title":2011},
				 {"title":2012},
				 {"title":2013}]
	initArray(years,"purple","year");
	
    var data = teams.concat(countries,venues,years);
    
    var height = 700, width = 1200, poolWidth = 100, isStart = false;
    var svg = d3.select("body")
                .append("svg")
                .attr("height",height)
                .attr("width",width)
				.style("position","absolute");
	var container = d3.select("body")
					.append("svg")
					.attr("id","container")
					.attr("height",height)
					.attr("width",width)
					.style("position","absolute")
					.style("display","none");
					
    var pool = svg.append("rect")
    		.attr("x",0)
    		.attr("y",0)
    		.attr("fill","yellow")
    		.attr("width",poolWidth)
    		.attr("height",height)
			.attr("id","pool")
			.on("click",showDetails);
	
	var descriptions = svg.selectAll("text.desc")
						.data(data)
						.enter()
						.append("text")
						.attr("class","desc")
						.attr("fill","black")
						.attr("font-family","sans-serif")
						.attr("font-size", "15px")
						.attr("x",function(d,i){
							if(d.type != "year"){
								return 900;
							}
						})
						.attr("y",function(d,i){
							var base = 100+i*15
							if(d.type=="country"){
								base += 10;
							}else if(d.type=="venue"){
								base += 20;
							}else if(d.type=="year"){
								return;
							}
							return base;
						
						})
						.text(function(d){return d.title + " : " + d.text;})
	
    var force = d3.layout.force()
                          .nodes(data)
                          .links([])
                          .size([width,height])
                          .linkDistance([80])
                          .charge([-1200])
                          .gravity(0.3)
                          .start();
    
    var nodes = svg.selectAll("circle")
			.data(data)
			.enter()
			.append("circle")
			.attr("r",40)
			.style("fill",function(d){return d.color})
			.call(force.drag)
			.on("mousedown",function(){isStart = true;});
    
	var texts = svg.selectAll("text.title")
				.data(data)
				.enter()
				.append("text")
				.attr("class","title")
				.attr("fill","white")
				.attr("font-family","sans-serif")
				.attr("font-size", "30px")
				.text(function(d){return d.title;}); 
	
	
	
    force.on("tick", function(e){
      nodes.each(function(d){
		if(d.x-100<100 && isStart){
			d.x += (150-d.x)*0.8;
		}
	  })
		.attr("cx",function(d){return d.x-100;})
		.attr("cy",function(d){return d.y;});
      texts.attr("transform", function(d){return "translate("+(d.x-120)+","+(d.y+10)+")";});
    })
	
    function initArray(data,color,type){
      for(var i=0;i<data.length;i++){
        data[i].color = color;
		data[i].type = type;
      }
      return data;
    }
    
	var Pad = function(container){
		
		this.background = container.append("rect")
									.attr("x",0)
									.attr("y",0)
									.attr("fill","white")
									.attr("width",width)
									.attr("height",height)
									.attr("id","background")
									//.style("display","none");
									
		this.closeButton = container.append("circle")
									.attr("cx",width-50)
									.attr("cy",50)
									.attr("r",20)
									.attr("id","closeButton")
									.attr("fill","red")
									//.style("display","none")
									.on("mousedown",function(){
										container.style("display","none");
									});
		container.append("text")
					.attr("x",width-55)
					.attr("y",55)
					.attr("font-size",15)
					.text("X")
		
		this.open = function(nodes){
			container.selectAll(".graph").remove();
			
			if(nodes.length == 1){
				container.style("display","block");
				displayOne(nodes[0]);
			}else if(nodes.length == 2){
				container.style("display","block");
				displayTwo(nodes[0],nodes[1]);
			}
		};
		
		this.close = function(){
			container.style("display","none");
		};
	};
	
	var pad = new Pad(container);
	
	function showDetails(){
		var pending = [];
		for(var i=0;i<data.length;i++){
			if(data[i].x-100<100){
				pending.push(data[i]);
			}
		}
		pad.open(pending);
	}
	
	function displayOne(node){
		if(node.type == "team"){
			var data1 = [{"data":tpData,"color":"red"}];
			lineChart(node,data1);
		}else if(node.type == "country"){
			var data2 = [{"data":tpData,"color":"red"},{"data":tdData,"color":"blue"}];
			lineChart(node,data2);
		}
	}
	
	function displayTwo(node1,node2){
		if(node1.type=='team' && node2.type=='venue'){
			pieChart(pieData);
		}else if(node1.type=='team' && node2.type=='country'){
			barChart(barData);
		}
	}
	
    var tpData = [{round:0,points:0},
                  {round:1,points:2},
                  {round:2,points:2},
                  {round:3,points:4},
                  {round:4,points:6},
                  {round:5,points:6},
                  {round:6,points:6},
                  {round:7,points:8},
                  {round:8,points:10},
                  {round:9,points:10},
                  {round:10,points:12},
                  {round:11,points:14},
                  {round:12,points:16},
                  {round:13,points:18},
                  {round:14,points:20}];
    
	var tdData = [{round:0,points:0},
                  {round:1,points:2},
                  {round:2,points:4},
                  {round:3,points:4},
                  {round:4,points:6},
                  {round:5,points:8},
                  {round:6,points:8},
                  {round:7,points:10},
                  {round:8,points:10},
                  {round:9,points:12},
                  {round:10,points:12},
                  {round:11,points:14},
                  {round:12,points:14},
                  {round:13,points:14},
                  {round:14,points:16}];
	
	function lineChart(node,data){
		var margin = {top:20,right:20,bottom:20,left:100},
			width = 1000 - margin.left - margin.right,
			height = 480;
		var x = d3.scale.linear().domain([0,14]).range([0, width]);
		var y = d3.scale.linear().domain([0,20]).range([height, 0]);
		var xAxis = d3.svg.axis().scale(x).orient("bottom");
		var yAxis = d3.svg.axis().scale(y).orient("left");
		var line = d3.svg.line()
							.x(function(d) { return x(d.round); })
							.y(function(d) { return y(d.points); });
		container.append("g")
					.attr("class","axis graph")
					.attr("transform","translate("+margin.left+","+(height+margin.top)+")")
					.call(xAxis);
		container.append("g")
					.attr("class","axis graph")
					.attr("transform","translate("+margin.left+","+margin.top+")")
					.call(yAxis)
		
		for(var i=0;i<data.length;i++){
			container.append("path")
						.attr("class","line graph")
						.attr("d",line(data[i].data))
						.attr("stroke",data[i].color)
						.attr("stroke-width",2)
						.attr("transform","translate("+margin.left+","+margin.top+")");
		}
	}
	
	pieData =  [{"text":"win","percentage":66,"color":"DarkSeaGreen"},
				{"text":"lose","percentage":34,"color":"LightSalmon"}];
				
	function pieChart(data){
		var arc = d3.svg.arc()
						.outerRadius(200)
						.innerRadius(0);
		var pie = d3.layout.pie()
					.sort(null)
					.value(function(d){return d.percentage})
		var g = container.selectAll(".arc")
						.data(pie(data))
						.enter()
						.append("g")
						.attr("transform","translate(500,250)")
						.attr("class","arc graph");
		g.append("path")
			.attr("d", arc)
			.style("fill",function(d){return d.data.color});
		g.append("text")
		  .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
		  .attr("dy", ".35em")
		  .style("text-anchor", "middle")
		  .text(function(d) { return d.data.text+":"+d.data.percentage+"%"; });
	}
	
	barData =  [{"year":2008,"rate":33},
				{"year":2009,"rate":66},
				{"year":2010,"rate":50},
				{"year":2011,"rate":33},
				{"year":2012,"rate":83},
				{"year":2013,"rate":100}]
	
	function barChart(data){
		var margin = {top:20,right:20,bottom:20,left:100},
			width = 1000 - margin.left - margin.right,
			height = 480;
		var x = d3.scale.ordinal().domain(data.map(function(d){return d.year})).rangeRoundBands([0, width],0.1);
		var y = d3.scale.linear().domain([0,100]).range([height, 0]);
		var xAxis = d3.svg.axis().scale(x).orient("bottom");
		var yAxis = d3.svg.axis().scale(y).orient("left");
		var line = d3.svg.line()
							.x(function(d) { return x(d.round); })
							.y(function(d) { return y(d.points); });
		container.append("g")
					.attr("class","axis graph")
					.attr("transform","translate("+margin.left+","+(height+margin.top)+")")
					.call(xAxis);
		container.append("g")
					.attr("class","axis graph")
					.attr("transform","translate("+margin.left+","+margin.top+")")
					.call(yAxis)
		
		container.selectAll(".bar")
					.data(data)
					.enter()
					.append("rect")
					.attr("class","bar graph")
					.attr("x",function(d){return x(d.year)})
					.attr("width",x.rangeBand())
					.attr("y",function(d){return y(d.rate)})
					.attr("height",function(d){return height - y(d.rate)})
					.attr("transform","translate("+margin.left+","+margin.top+")");

	}
  </script>
  </body>
</html>
